---
title: 'AWS RDS SQLServer è¿˜åŸæ•…éšœ Troubleshooting'
date: '2023-02-18'
lastmod: '2024-12-01'
tags: ['MSSQL', 'Troubleshooting']
summary: 'æœ¬æ–‡è®¨è®ºäº†åœ¨AWS RDS SQLServerä¸­è¿›è¡Œæ•°æ®åº“è¿˜åŸæ—¶é‡åˆ°çš„æ•…éšœåŠå…¶æ’æŸ¥è¿‡ç¨‹ã€‚é€šè¿‡å®šæœŸå¤‡ä»½å’Œä½¿ç”¨T-SQLå­˜å‚¨è¿‡ç¨‹è¿›è¡Œè¿˜åŸï¼Œä½œè€…è®°å½•äº†åœ¨æ‰§è¡Œè¿˜åŸä»»åŠ¡æ—¶å‡ºç°çš„å¼‚å¸¸ï¼ŒåŒ…æ‹¬è¿æ¥ä¸¢å¤±å’Œä»»åŠ¡ä¸­æ–­ã€‚æœ€ç»ˆå‘ç°ï¼ŒRDSå®ä¾‹çš„é‡å¯å’ŒEC2èŠ‚ç‚¹çš„æ›´æ¢æ˜¯å¯¼è‡´è¿™äº›é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚'
---

### èƒŒæ™¯

å…¶å®ƒæ•°æ®ä¸­å¿ƒçš„ SQLServer å®šæœŸå¤‡ä»½å¹¶å°†å¤‡ä»½æ–‡ä»¶ä¸Šä¼  S3ï¼Œå†è¿˜åŸåˆ° AWS RDSï¼ˆSQLServerï¼‰ï¼Œé‡‡ç”¨æ¯å‘¨æœ«ä¸€æ¬¡å…¨é‡å¤‡ä»½+å·¥ä½œæ—¥æ¯å¤©ä¸€æ¬¡å·®å¼‚å¤‡ä»½çš„æ‰§è¡Œè®¡åˆ’ã€‚

æˆ‘ä½¿ç”¨ `pymssql ` åº“è®¿é—® AWS RDSï¼Œå¹¶æ‰§è¡Œ AWS æä¾›çš„ `stored procedure` æ¥è¿›è¡Œæ•°æ®åº“è¿˜åŸï¼ŒT-SQL å¦‚ä¸‹ï¼Œè¯¦è§ AWS æ–‡æ¡£ã€‚ 


```sql
exec msdb.dbo.rds_restore_database
	@restore_db_name='database_name',
	@s3_arn_to_restore_from='arn:aws:s3:::bucket_name/file_name.extension',
	@with_norecovery=0|1,
	[@kms_master_key_arn='arn:aws:kms:region:account-id:key/key-id'],
	[@type='DIFFERENTIAL|FULL'];
```

[https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/SQLServer.Procedural.Importing.html#SQLServer.Procedural.Importing.Native.Using.Restore](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/SQLServer.Procedural.Importing.html#SQLServer.Procedural.Importing.Native.Using.Restore)

<br/>

åˆ›å»ºä¸€ä¸ªè¿˜åŸ Task åï¼Œè½®è¯¢ Task æ‰§è¡ŒçŠ¶æ€ã€‚

T-SQLï¼š


```sql
exec msdb.dbo.rds_task_status
	[@db_name='database_name'],
	[@task_id=ID_number];
```

<br/>

ä»£ç é€»è¾‘å¦‚ä¸‹ï¼Œè¿™é‡Œå€ŸåŠ© `redo` åœ¨æ•°æ®åº“è¿æ¥ä¸¢å¤±åè¿›è¡Œé‡è¯•ï¼Œé‡æ–°å»ºç«‹æ•°æ®åº“è¿æ¥ã€‚


```python
@redo.retriable(attempts=5, sleeptime=60, retry_exceptions=(DisconnectError,))
def wait(self, creds: SqlCreds, delay=60):
    """
    SQL Server also has an "Idle Connection Timeout" setting, which determines how long a connection
    can be idle (not used) before it is closed. This setting is controlled by the "Remote Query Timeout"
    configuration option and is set to 600 seconds (10 minutes) by default.
    """
    conn = creds.connect()
    try:
        while True:
            status = self.status(conn=conn)
            lifecycle = status["lifecycle"]
            database = self.meta["db_name"]
            if lifecycle in (LifeCycle.IN_PROGRESS, LifeCycle.CREATED):
                LOG.info(f"Waiting for {database} to be restored...")
                time.sleep(delay)
            elif lifecycle == LifeCycle.SUCCESS:
                return
            elif lifecycle == LifeCycle.ERROR:
                raise pymssql.OperationalError(
                    f"Error restoring {database}\t{json.dumps(status, default=str)}"
                )
            else:
                raise ValueError(
                    f"Unknown lifecycle: {lifecycle}\t{json.dumps(status, default=str)}"
                )
    except pymssql.OperationalError as e:
        LOG.error(f"Error waiting: {e}")
        if creds.is_disconnect(e, conn):
            raise DisconnectError(f"PyMSSQL connection has gone away: {e}")
    finally:
        conn.close()
```

<br/>

### å¼‚å¸¸ 1

è¿™æ˜¯ RDS  `rds_task_status` çš„æ‰§è¡Œå¼‚å¸¸æ—¥å¿—ï¼š


```plain text
[2023-02-17 03:28:23.083] Aborted the task because of a task failure or a concurrent RESTORE_DB_DIFFERENTIAL request.
[2023-02-17 03:28:23.643] Task has been aborted
[2023-02-17 03:28:23.910] Task was initiated on server name: EC2AMAZ-7POJKEI, current server name: EC2AMAZ-T85JIN4. Cannot complete the task, please try again.
```

<br/>

### å¼‚å¸¸ 2

è¿™æ˜¯ Python ç¨‹åºçš„æ‰§è¡Œå¼‚å¸¸æ—¥å¿—ï¼š


```python
2023-02-17 02:02:33,089: ERROR : Error waiting: (20047, b'DB-Lib error message 20047, severity 9:\nDBPROCESS is dead or not enabled\n')
2023-02-17 02:04:02,066: INFO : retry: calling wait with args: (FullBackup(id='MARTPH_20230217|2023-02-11|FULL|1|2023-02-17'), <bayer_cdp_common_utils.mssql_handler.SqlCreds object at 0x7ff9144bc4e0>), kwargs: 
{}
, attempt #3
2023-02-17 02:07:17,487: INFO : retry: calling wait with args: (FullBackup(id='MARTPH_20230217|2023-02-11|FULL|1|2023-02-17'), <bayer_cdp_common_utils.mssql_handler.SqlCreds object at 0x7ff9144bc4e0>), kwargs: 
{}
, attempt #4
2023-02-17 02:11:41,495: INFO : retry: calling wait with args: (FullBackup(id='MARTPH_20230217|2023-02-11|FULL|1|2023-02-17'), <bayer_cdp_common_utils.mssql_handler.SqlCreds object at 0x7ff9144bc4e0>), kwargs: 
{}
, attempt #5
2023-02-17 02:12:41,536: INFO : retry: Giving up on wait
Traceback (most recent call last):
  File "/tmp/runscript.py", line 230, in <module>
    raise e_type(e_value).with_traceback(new_stack)
  File "/tmp/glue-python-scripts-l7dpyz1k/ph-cdw-sqlserver-restore.py", line 90, in <module>
  File "/tmp/glue-python-scripts-l7dpyz1k/ph-cdw-sqlserver-restore.py", line 56, in _wait_for_restore
  File "/glue/lib/installation/bayer_cdp_common_utils/rds_restore_handler.py", line 837, in wait_for_restore
    bak.full_backup.wait(creds)
  File "/glue/lib/installation/redo/__init__.py", line 215, in _retriable_wrapper
    return retry(func, args=args, kwargs=kwargs, *retry_args, **retry_kwargs)
  File "/glue/lib/installation/redo/__init__.py", line 170, in retry
    return action(*args, **kwargs)
  File "/glue/lib/installation/bayer_cdp_common_utils/rds_restore_handler.py", line 408, in wait
    conn = creds.connect()
  File "/glue/lib/installation/bayer_cdp_common_utils/mssql_handler.py", line 36, in connect
    autocommit=autocommit,
  File "src/pymssql/_pymssql.pyx", line 653, in pymssql._pymssql.connect
pymssql._pymssql.OperationalError: (20009, b'DB-Lib error message 20009, severity 9:\nUnable to connect: Adaptive Server is unavailable or does not exist (fusion-q-1.cpmknfgp0x9h.rds.cn-north-1.amazonaws.com.cn)\nNet-Lib error during Connection timed out (110)\nDB-Lib error message 20009, severity 9:\nUnable to connect: Adaptive Server is unavailable or does not exist (fusion-q-1.cpmknfgp0x9h.rds.cn-north-1.amazonaws.com.cn)\nNet-Lib error during Connection timed out (110)\n')
```

<br/>

### Troubleshoots

ä»ä»¥ä¸‹éƒ¨åˆ†æ—¥å¿—å¯ä»¥å‘ç°å› ä¸ºæ•°æ®åº“æœåŠ¡çš„é—®é¢˜è¿æ¥ä¼šè¯ä¸­æ–­äº†ï¼Œå¹¶ä¸”ä¸‰æ¬¡é‡æ–°è¿æ¥éƒ½å¤±è´¥äº†ã€‚


```python
2023-02-17 02:02:33,089: ERROR : Error waiting: (20047, b'DB-Lib error message 20047, severity 9:\nDBPROCESS is dead or not enabled\n')
...
, attempt #5
2023-02-17 02:12:41,536: INFO : retry: Giving up on wait
```

<br/>

ä»¥ä¸Šé—®é¢˜å‡ºç°äº†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡å‡ºç°æ—¶æˆ‘ä»¥ä¸ºæ˜¯ `pymssql` çš„ `connection` è¶…æ—¶è¢« server ä¸»åŠ¨ä¸­æ–­äº†ï¼Œäºæ˜¯æˆ‘åŠ ä¸Š `redo` æœºåˆ¶ï¼Œå¸Œæœ›åœ¨è¿æ¥ä¸¢å¤±åé‡æ–°åˆ›å»ºå¹¶ä½¿ç”¨ï¼Œå‡ å¤©ä¹‹åå‘ç”Ÿäº†åŒæ ·çš„æŠ¥é”™ã€‚

æˆ‘éå¸¸çº³é—·ï¼Œå¹¶åœ¨çœ‹åˆ° GitHub ä¸Šçš„ç›¸ä¼¼ issue åæ€€ç–‘æ˜¯é‡è¯•åˆ›å»ºè¿æ¥çš„æ–¹å¼æœ‰é—®é¢˜ã€‚

[https://github.com/rails-sqlserver/activerecord-sqlserver-adapter/issues/402#issuecomment-1356793443](https://github.com/rails-sqlserver/activerecord-sqlserver-adapter/issues/402#issuecomment-1356793443)

<br/>

æˆ‘åˆè®¤çœŸçœ‹äº†æ—¥å¿—ï¼Œè¯•å›¾æ‰¾å‡ºä¸€äº›è››ä¸é©¬è¿¹ã€‚æŒ‰ç…§ä»£ç æ‰§è¡Œæµç¨‹ï¼Œä¸‹é¢æ˜¯ç¬¬ä¸€æ­¥çš„æŠ¥é”™ä¿¡æ¯ï¼š


```python
(20047, b'DB-Lib error message 20047, severity 9:\nDBPROCESS is dead or not enabled\n')
```

<br/>

è¿™æ˜¯ä¸‹ä¸€æ­¥ `reconnect` çš„æŠ¥é”™ï¼š


```python
(20009, b'DB-Lib error message 20009, severity 9:\nUnable to connect: Adaptive Server is unavailable or does not exist (xxx.amazonaws.com.cn)\nNet-Lib error during Connection timed out (110)\nDB-Lib error message 20009, severity 9:\nUnable to connect: Adaptive Server is unavailable or does not exist (xxx.amazonaws.com.cn)\nNet-Lib error during Connection timed out (110)\n')
```

<br/>

æ˜¾ç„¶ä¹‹å‰æ²¡æœ‰ä»”ç»†çœ‹ï¼Œè™½ç„¶éƒ½æ˜¯æ•°æ®åº“è¿æ¥çš„å¼‚å¸¸ï¼Œä½†ä¸¤æ¬¡å¼‚å¸¸ä¸èƒ½è§†ä¹‹ç›¸åŒï¼Œç¬¬ä¸€æ¬¡å¼‚å¸¸æ˜¯æ•°æ®åº“è¿æ¥è®¿é—®ä¸åˆ°æ•°æ®åº“äº†ï¼Œç¬¬äºŒæ¬¡å¼‚å¸¸æ˜¯è¿æ¥è¶…æ—¶ï¼ˆConnection timed outï¼‰ã€‚

<br/>

å…ˆæš‚åœå»çœ‹å¼‚å¸¸ 1ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾åˆ°è§£é‡Šï¼š

> Task was initiated on server name: EC2AMAZ-ABCDEFG, current server name: EC2AMAZ-MNOPQRS. Cannot complete the task, please try again.
Usually youâ€™ll see this error when a task is in progress on a mirrored instance and a failover happens. The new principal or primary does not know about the task in progress. This error can also appear when the task is in progress and the underlying EC2 machine has been replaced with a different one. In either case, reissue the task to solve the error.

[Migrating Microsoft SQL Server Enterprise Workloads to Amazon RDS: Part 1 | AWS Database Blog](https://aws.amazon.com/cn/blogs/database/migrating-microsoft-sql-server-enterprise-workloads-to-amazon-rds-part-1/?highlight=Task%20was%20initiated%20on%20server%20name#:~:text=Task%20was%20initiated%20on%20server%20name%3A%20EC2AMAZ%2DABCDEFG%2C%20current%20server%20name%3A%20EC2AMAZ%2DMNOPQRS.%20Cannot%20complete%20the%20task%2C%20please%20try%20again.)

å¾ˆè®©äººæ„å¤–ï¼ŒRDS å®ä¾‹åº•å±‚çš„ EC2 èŠ‚ç‚¹éš¾é“æ¢äº†ï¼Ÿæˆ‘å†³å®šå» AWS RDS æ§åˆ¶å°çœ‹ä¸€ä¸‹ã€‚

ğŸ’¡ è¿™é‡Œè¡¥å……ä¸€ç‚¹ï¼Œæ­¤å¤„å¤±è´¥çš„è¿˜åŸçš„ä»»åŠ¡æ˜¯å·®å¼‚å¤‡ä»½çš„è¿˜åŸï¼ˆDIFFERENTIALï¼‰ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥è¿˜åŸå…¨é‡å¤‡ä»½çš„ bak æ–‡ä»¶ï¼Œç¬¬äºŒæ­¥è¿˜åŸå·®å¼‚å¤‡ä»½çš„ bak æ–‡ä»¶ï¼Œä¸¤æ­¥åˆåœ¨ä¸€èµ·ä¸ºä¸€æ¬¡å®Œæ•´çš„ SQLServer å·®å¼‚è¿˜åŸã€‚

<br/>

é¦–å…ˆæ³¨æ„åˆ° RDS å®ä¾‹å¼€å¯äº†è‡ªåŠ¨å¤‡ä»½çš„åŠŸèƒ½ã€‚

![Untitled.png](/static/images/AWS-RDS-SQLServer-è¿˜åŸæ•…éšœ-Troubleshooting/Untitled.png)

![Untitled.png](/static/images/AWS-RDS-SQLServer-è¿˜åŸæ•…éšœ-Troubleshooting/Untitled.png)

<br/>

å¯ä»¥ä» events ä¸­çœ‹åˆ°æœ€è¿‘å¤‡ä»½çš„è®°å½•ã€‚

![Untitled.png](/static/images/AWS-RDS-SQLServer-è¿˜åŸæ•…éšœ-Troubleshooting/Untitled.png)

<br/>

æˆ‘ç¿»åˆ° RDS æœåŠ¡æ—¥å¿—ï¼Œçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæœ‰æ²¡æœ‰å¼‚å¸¸è®°å½•ã€‚

![Untitled.png](/static/images/AWS-RDS-SQLServer-è¿˜åŸæ•…éšœ-Troubleshooting/Untitled.png)


```plain text
2023-02-17 02:34:16.42 Server      Microsoft SQL Server 2016 (SP3) (KB5003279) - 13.0.6300.2 (X64) 
	Aug  7 2021 01:20:37 
	Copyright (c) Microsoft Corporation
	Standard Edition (64-bit) on Windows Server 2016 Datacenter 10.0 <X64> (Build 14393: ) (Hypervisor)

2023-02-17 02:34:16.43 Server      UTC adjustment: 0:00
2023-02-17 02:34:16.43 Server      (c) Microsoft Corporation.
2023-02-17 02:34:16.43 Server      All rights reserved.
2023-02-17 02:34:16.43 Server      Server process ID is 4760.
2023-02-17 02:34:16.43 Server      System Manufacturer: 'Amazon EC2', System Model: 'm5.xlarge'.
2023-02-17 02:34:16.43 Server      Authentication mode is MIXED.
2023-02-17 02:34:16.43 Server      Logging SQL Server messages in file 'D:\rdsdbdata\Log\ERROR'.
2023-02-17 02:34:16.43 Server      The service account is 'awscn\EC2AMAZ-T85JIN4$'. This is an informational message; no user action is required.
2023-02-17 02:34:16.43 Server      Registry startup parameters: 
	 -d D:\rdsdbdata\DATA\master.mdf
	 -e D:\rdsdbdata\Log\ERROR
	 -l D:\rdsdbdata\DATA\mastlog.ldf
	 -k 20.000000
	 -T 3226
2023-02-17 02:34:16.43 Server      Command Line Startup Parameters:
	 -s "MSSQLSERVER"
...

2023-02-13 22:08:52.60 Server      Microsoft SQL Server 2016 (SP3) (KB5003279) - 13.0.6300.2 (X64) 
	Aug  7 2021 01:20:37 
	Copyright (c) Microsoft Corporation
	Standard Edition (64-bit) on Windows Server 2016 Datacenter 10.0 <X64> (Build 14393: ) (Hypervisor)

2023-02-13 22:08:52.60 Server      UTC adjustment: 0:00
2023-02-13 22:08:52.60 Server      (c) Microsoft Corporation.
2023-02-13 22:08:52.60 Server      All rights reserved.
2023-02-13 22:08:52.60 Server      Server process ID is 144.
2023-02-13 22:08:52.60 Server      System Manufacturer: 'Amazon EC2', System Model: 'm5.xlarge'.
2023-02-13 22:08:52.60 Server      Authentication mode is MIXED.
2023-02-13 22:08:52.60 Server      Logging SQL Server messages in file 'D:\rdsdbdata\Log\ERROR'.
2023-02-13 22:08:52.60 Server      The service account is 'awscn\EC2AMAZ-7POJKEI$'. This is an informational message; no user action is required.
2023-02-13 22:08:52.60 Server      Registry startup parameters: 
	 -d D:\rdsdbdata\DATA\master.mdf
	 -e D:\rdsdbdata\Log\ERROR
	 -l D:\rdsdbdata\DATA\mastlog.ldf
	 -k 20.000000
	 -T 3226
2023-02-13 22:08:52.60 Server      Command Line Startup Parameters:
	 -s "MSSQLSERVER"
...
```

<br/>

å¾ˆæ˜æ˜¾ï¼ŒRDS å®ä¾‹è¢«é‡å¯äº†ï¼Œå¹¶ä¸” EC2 èŠ‚ç‚¹ä¹Ÿæ›´æ¢äº†ï¼Œé‡å¯çš„æ—¶é—´é—´éš”ä¸º 7 å¤©ï¼Œå¯¹åº”è‡ªåŠ¨å¤‡ä»½è®¾ç½®çš„æ—¶é—´ã€‚åˆ°è¿™é‡Œï¼Œä¸¤ä¸ªå¼‚å¸¸çš„åŸå› éƒ½æ‰¾åˆ°äº†ã€‚

RDS å®ä¾‹é‡å¯å¯¼è‡´ `pymssql` çš„è¿æ¥ä¸¢å¤±å¹¶ä¸”é‡è¯•å¤±è´¥ï¼ŒRDS é‡å¯åˆ‡æ¢ EC2 å¯¼è‡´å·®å¼‚è¿˜åŸä¸¤ä¸ªæ­¥éª¤æ‰§è¡Œåœ¨ä¸åŒçš„ EC2 ä¸Šã€‚

<br/>

